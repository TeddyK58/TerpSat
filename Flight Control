

#include <SoftwareSerial.h>  
#include <Wire.h>
#include <SSC.h>
#include "Adafruit_MCP9808.h"
#include "Balloonduino_lib.h"
#include <Adafruit_BNO055.h>
#include <Adafruit_Sensor.h>
#include <utility/imumaths.h>
#include <Adafruit_GPS.h>

#define GPSSerial Serial1

// Set GPSECHO to 'false' to turn off echoing the GPS data to the Serial console
// Set to 'true' if you want to debug and listen to the raw GPS sentences
#define GPSECHO false

// Connect to the GPS on the hardware port
Adafruit_GPS GPS(&GPSSerial);

uint32_t timer = millis();

SoftwareSerial Xbee(Rx, Tx);                          //whatever the RX and TX is for the ballonduino, unsure currently
SSC ssc(0x28, 255);     /                              /whatever pin powers the ssc sensor, also creation of SSC object in code
Adafruit_MCP9808 tempsensor = Adafruit_MCP9808();     //Creation of MCP9808 object
Adafruit_BNO055 bno = Adafruit_BNO055(55);     //55 is a place holder, whatever pin is actually the BNO is used here

void setup() {
  XBEE.begin(9600);   //setting baud rate for xbee, make sure it's the correct settings
  XBEE_serial.begin(9600);
  SPI.begin();
  pinMode(53,OUTPUT);
  if (!SD.begin(53)) {
    serial.println("SD Card NOT detected.");
  }
  else{
    serial.println("SD Card detected!");
  }
   if (!tempsensor.begin()) {
    Serial.println("Couldn't find MCP9808!");
    
   }
  ssc.setMinRaw(0); //check data sheet for actual correct settings, just basic format here
  ssc.setMaxRaw(16383);
  ssc.setMinPressure(0.0);
  ssc.setMaxPressure(15);
  ssc.start();
  
  bno.setExtCrystalUse(true);

  // connect at 115200 so we can read the GPS fast enough and echo without dropping chars
  Serial.begin(115200);
  GPS.sendCommand(PMTK_SET_NMEA_OUTPUT_RMCONLY)
  GPS.sendCommand(PMTK_SET_NMEA_UPDATE_1HZ); // 1 Hz update rate
}

void loop() {
  ssc.update();
  float pressure = ssc.pressure();
  tempsensor.shutdown_wake(0);
  float c = tempsensor.readTempC();
  float f = (c*9.0/5.0)+32;
  
  imu::Vector<3> mag = bno.getVector(Adafruit_BNO055::VECTOR_MAGNETOMETER);  //magnetometier vectors in uT
  float magx = mag.x();
  float magy = mag.y();
  float magz = mag.z();
  
  char c = GPS.read();

  if (GPS.newNMEAreceived()) {
    Serial.println(GPS.lastNMEA()); // this also sets the newNMEAreceived() flag to false
    GPS.parse(GPS.lastNMEA()) // this also sets the newNMEAreceived() flag to false
  }
  
  if (timer > millis()) timer = millis();

  //for now, everything is printed to serial
  //we will need to store this somehow
  if (millis() - timer > 2000) {
    timer = millis(); // reset the timer
    Serial.print("\nTime: ");
    Serial.print(GPS.hour, DEC); Serial.print(':');
    Serial.print(GPS.minute, DEC); Serial.print(':');
    Serial.print(GPS.seconds, DEC); Serial.print('.');
    Serial.println(GPS.milliseconds);
    Serial.print("Date: ");
    Serial.print(GPS.day, DEC); Serial.print('/');
    Serial.print(GPS.month, DEC); Serial.print("/20");
    Serial.println(GPS.year, DEC);
    Serial.print("Fix: "); Serial.print((int)GPS.fix);
    Serial.print(" quality: "); Serial.println((int)GPS.fixquality);
    if (GPS.fix) {
      Serial.print("Location: ");
      Serial.print(GPS.latitude, 4); Serial.print(GPS.lat);
      Serial.print(", ");
      Serial.print(GPS.longitude, 4); Serial.println(GPS.lon);
      Serial.print("Speed (knots): "); Serial.println(GPS.speed);
      Serial.print("Angle: "); Serial.println(GPS.angle);
      Serial.print("Altitude: "); Serial.println(GPS.altitude);
      Serial.print("Satellites: "); Serial.println((int)GPS.satellites);
    }
  }
}
